#!/usr/bin/env bash
# core/baux — BAUX entrypoint v0.3.0-pre (cluster-ready)
# This is the single most important file in the entire OS.

set -euo pipefail

export BAUX_HOME="/usr/share/baux"
export NVIM_INIT="$BAUX_HOME/nvim/init.lua"
TMUX_CONF="$BAUX_HOME/tmux/baux.conf"
SESSION="baux-$(hostname)"

# ──────────────────────────────────────────────────────────────
# 1. Anti-nesting & remote detection (the tmux-in-tmux killer)
# ──────────────────────────────────────────────────────────────
if [[ -n "${BAUX_REMOTE:-}" || -n "${SSH_TTY:-}" || -n "${SSH_CONNECTION:-}" ]]; then
  # We were reached via `baux pull` or plain SSH into a BAUX node
  # → Do NOT start another tmux. Just give a clean shell.
  export BAUX_INSIDE_REMOTE=1
  exec bash --login
fi

# ──────────────────────────────────────────────────────────────
# 2. Sub-command routing (baux vpn, baux hosts, etc.)
# ──────────────────────────────────────────────────────────────
if [[ $# -gt 0 ]]; then
  case "$1" in
  vpn | hosts | pull | push | bot | drop)
    exec "$BAUX_HOME/scripts/baux-$1" "${@:2}"
    ;;
  --version | -v)
    echo "BAUX v0.3.0-pre (cluster-ready)"
    exit 0
    ;;
  --help | -h)
    cat <<'HELP'
BAUX — the immortal terminal OS

Usage: baux [command]

Commands:
  vpn      — manage WireGuard cluster (init / add / status)
  hosts    — list all online BAUX nodes
  pull     — pull a remote pane (future)
  push     — push current session (future)
  bot      — manage BAUX BOT
  drop     — manage DROP-BAUX storage (future)

Just type "baux" to enter the workspace.
HELP
    exit 0
    ;;
  esac
fi

# ──────────────────────────────────────────────────────────────
# 3. Normal local entry — start tmux with our config
# ──────────────────────────────────────────────────────────────
exec tmux -f "$TMUX_CONF" new-session -A -s "$SESSION"
